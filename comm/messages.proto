syntax = "proto3";

package lilsim;

// Common header on almost everything
message Header {
  uint64 tick      = 1;
  double sim_time  = 2;  // seconds
  uint32 version   = 3;  // protocol version
}

message Vec2 {
  double x = 1;
  double y = 2;
}

message ScalarRange {
  double min = 1;
  double max = 2;
}

message ParameterMeta {
  string name = 1;
  double default_value = 2;
  ScalarRange limits = 3;
}

message SettingMeta {
  string name = 1;
  repeated string options = 2;
  uint32 default_index = 3;
}

message InputMeta {
  string name = 1;
  ScalarRange limits = 2;
}

message StateMeta {
  string name = 1;
  ScalarRange limits = 2;
}

message ModelMetadata {
  Header header = 1;
  string model_name = 2;
  uint64 schema_version = 3;
  repeated ParameterMeta params = 4;
  repeated SettingMeta settings = 5;
  repeated InputMeta inputs = 6;
  repeated StateMeta states = 7;
}

// ============ State stream ============

message SceneState {
  Header header = 1;
  uint64 metadata_version = 2;
  repeated double state_values = 3;
  repeated double input_values = 4;
  repeated double param_values = 5;
  repeated uint32 setting_values = 6;
}

message StateUpdate {
  SceneState scene = 1;
}

// ============ Control async ============

message ControlAsync {
  Header header = 1;
  uint64 metadata_version = 2;
  repeated double input_values = 3;
}

// ============ Control sync ============

message ControlRequest {
  Header header = 1;
  SceneState scene = 2; // includes metadata version + latest state snapshot
}

message ControlReply {
  Header header = 1; // tick this control applies to
  uint64 metadata_version = 2;
  repeated double input_values = 3;
}

// ============ Admin RPC ============

enum AdminCommandType {
  INIT  = 0;
  RESET = 1;
  PAUSE = 2;
  RUN   = 3;
  STEP  = 4;
  SET_PARAMS = 5;
  SET_SETTINGS = 6;
  SET_CONTROL_MODE = 7;  // Set sync/async mode and control source
  SET_TRACK = 8; // Load track from file
  LOAD_PARAM_PROFILE = 9;
  CLEAR_PARAM_PROFILE = 10;
  GET_METADATA = 11;
  SET_SIM_CONFIG = 12;
  GET_SIM_CONFIG = 13;
}

message IndexedDouble {
  uint32 index = 1;
  double value = 2;
}

message IndexedUInt32 {
  uint32 index = 1;
  uint32 value = 2;
}

message AdminCommand {
  Header           header     = 1;
  AdminCommandType type       = 2;
  uint64           step_count = 3;  // for STEP
  repeated IndexedDouble  param_updates = 4;   // for SET_PARAMS/INIT
  repeated IndexedUInt32  setting_updates = 5; // for SET_SETTINGS/INIT
  bool             sync_mode  = 6;  // for SET_CONTROL_MODE
  uint32           control_period_ms = 7; // milliseconds between control requests (sync mode)
  string           track_path = 8;  // for SET_TRACK
  string           param_profile_path = 9; // for LOAD_PARAM_PROFILE
  optional bool    use_external_control = 10; // true = ZeroMQ client, false = GUI
  optional double  timestep = 11; // milliseconds, for SET_SIM_CONFIG
  optional double  run_speed = 12; // multiplier, for SET_SIM_CONFIG
  optional double  control_period_ms_staged = 13; // milliseconds, applies on reset
  optional double  control_delay_ms_staged  = 14; // milliseconds, applies on reset
}

message AdminReply {
  Header header  = 1;
  bool   success = 2;
  string message = 3;
  ModelMetadata metadata = 4;
  optional double timestep = 5; // milliseconds
  optional double run_speed = 6;
  optional double control_period_ms = 7;
  optional double control_delay_ms  = 8;
}

// ============ Marker visualization ============

message Color {
  uint32 r = 1; // 0-255
  uint32 g = 2;
  uint32 b = 3;
  uint32 a = 4;
}

message Scale2D {
  float x = 1;
  float y = 2;
}

message Pose {
  double x   = 1;
  double y   = 2;
  double yaw = 3;
}

enum FrameId {
  WORLD = 0;
  CAR   = 1;
}

message CarMarker {
  double wheelbase = 1;
  double track_width = 2;
  optional double wheel_fl_angle = 3;
  optional double wheel_fr_angle = 4;
  optional double opacity = 5;
  optional double tint_opacity = 6;
}

enum MarkerType {
  TEXT          = 0;
  ARROW         = 1;
  RECTANGLE     = 2;
  CIRCLE        = 3;
  LINE_STRIP    = 4;
  CIRCLE_LIST   = 5;
  TRIANGLE_LIST = 6;
  MESH_2D       = 7;
  CAR_SPRITE    = 8;
}

message Marker {
  string     ns           = 1;  // namespace
  int32      id           = 2;  // unique within namespace
  FrameId    frame_id     = 12; // Reference frame (default: WORLD)
  MarkerType type         = 3;
  Pose       pose         = 4;
  Color      color        = 5;
  Scale2D    scale        = 6;
  string     text         = 7;  // For TEXT markers
  repeated Vec2 points    = 8;  // For LINE_STRIP, CIRCLE_LIST, TRIANGLE_LIST
  repeated Color colors   = 11; // Per-vertex colors (for LINE_STRIP, TRIANGLE_LIST, CIRCLE_LIST)
  double     ttl_sec      = 9;  // Time-to-live (0 = infinite)
  bool       visible      = 10; // Visibility flag
  optional CarMarker car  = 13; // Only for CAR_SPRITE
}

message MarkerArray {
  Header header = 1;
  repeated Marker markers = 2;
}

enum MarkerCommandType {
  DELETE_MARKER     = 0;
  DELETE_NAMESPACE  = 1;
  CLEAR_ALL         = 2;
}

message MarkerCommand {
  Header header = 1;
  MarkerCommandType type = 2;
  string ns = 3;      // For DELETE_MARKER and DELETE_NAMESPACE
  int32 id = 4;       // For DELETE_MARKER
}
